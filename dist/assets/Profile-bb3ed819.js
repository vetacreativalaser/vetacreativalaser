import{c as z,u as Ne,v as Se,r as l,s as o,j as e,U as Y,L as C,B as u,b as ee,I as p}from"./index-7f1f9d48.js";import{T as Ce,a as Pe,b as P,c as k}from"./tabs-8885e58d.js";import{L as f}from"./label-2e4aee24.js";import{S as I,D as ke}from"./dialog-4bd7957e.js";import{S as _e,P as Ee,N as Le,b as Te,C as Ie,a as ze}from"./pagination-02c0c2c3.js";import{S as se}from"./shopping-bag-6dcfffa2.js";import{T as Ae}from"./trash-2-55b83d28.js";import"./index-2bb2294e.js";import"./index-9d6f570a.js";/**
 * @license lucide-react v0.378.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $e=z("LayoutDashboard",[["rect",{width:"7",height:"9",x:"3",y:"3",rx:"1",key:"10lvy0"}],["rect",{width:"7",height:"5",x:"14",y:"3",rx:"1",key:"16une8"}],["rect",{width:"7",height:"9",x:"14",y:"12",rx:"1",key:"1hutg5"}],["rect",{width:"7",height:"5",x:"3",y:"16",rx:"1",key:"ldoo1y"}]]);/**
 * @license lucide-react v0.378.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=z("PenLine",[["path",{d:"M12 20h9",key:"t2du7b"}],["path",{d:"M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z",key:"ymcmye"}]]);/**
 * @license lucide-react v0.378.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=z("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]),He=()=>{var X;const{user:n,logout:ae}=Ne(),te=Se(),[g,re]=l.useState(0),[m,le]=l.useState([]),[A,ne]=l.useState([]),[ie,oe]=l.useState([]),[$,ce]=l.useState([]),[h,q]=l.useState({name:"",email:"",phone:""}),[x,F]=l.useState(!1),[w,y]=l.useState(""),[N,U]=l.useState(""),[D,M]=l.useState(""),[de,me]=l.useState(!0);l.useState(null);const[O,R]=l.useState(null),[j,_]=l.useState(null),[E,J]=l.useState([]),[he,V]=l.useState(0),[xe,ue]=l.useState(typeof window<"u"?window.innerWidth:1200),L=Math.floor(g/100),S=g%100,B=L+1,[W,H]=l.useState(!1),[pe,T]=l.useState(!1);l.useEffect(()=>{const s=Math.floor(g/100);s>he&&o.from("profiles").update({level:s}).eq("email",n.email).then(()=>{var a;V(s),fe(n.email,h.name||((a=n.user_metadata)==null?void 0:a.name)||"",s)}).catch(a=>{console.error("Error actualizando nivel en Supabase:",a.message)})},[g]);const G=async()=>{if(!n)return;const{data:s,error:a}=await o.from("reviews").select("*").eq("user_id",n.id).order("created_at",{ascending:!1});a&&console.error("Error cargando reseñas:",a.message),le(s||[])},fe=async(s,a,t)=>{try{const{data:{session:r}}=await o.auth.getSession();await fetch("https://dspsrnprvrpjrkicxiso.functions.supabase.co/send-points-update",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r==null?void 0:r.access_token}`},body:JSON.stringify({email:s,name:a,level:t,changeType:"levelup"})})}catch(r){console.error("Error al enviar correo de subida de nivel:",r)}};l.useEffect(()=>{(async()=>{var c,d;if(!n)return;const{data:a}=await o.from("profiles").select("points, name, phone, level").eq("email",n.email).single();a&&(re(a.points||0),V(a.level||0),q({name:a.name||((c=n.user_metadata)==null?void 0:c.name)||"",email:n.email||"",phone:a.phone||((d=n.user_metadata)==null?void 0:d.phone)||""}));const{data:t}=await o.from("favorites").select("*").eq("user_id",n.id);ne(t||[]);const{data:r}=await o.from("products").select("id, name");oe(r||[]);const{data:i}=await o.from("purchases").select("*").eq("user_id",n.id).order("created_at",{ascending:!1});ce(i||[]),await G(),me(!1)})()},[n]),l.useEffect(()=>{const s=()=>ue(window.innerWidth);return window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)},[]),l.useEffect(()=>{const s=[];m.forEach(a=>{const t=typeof a.image_urls=="string"?JSON.parse(a.image_urls):a.image_urls;Array.isArray(t)&&t.forEach(r=>{s.push({url:r,review:a})})}),J(s)},[m]),l.useEffect(()=>{const s=async()=>{const t=[...new Set(m.map(c=>c.user_id))],{data:r,error:i}=await o.from("profiles").select("id, email, name").in("id",t);if(!i&&r){const c={};r.forEach(d=>{c[d.id]={email:d.email,name:d.name}})}},a=[];m.forEach(t=>{const r=typeof t.image_urls=="string"?JSON.parse(t.image_urls):t.image_urls;Array.isArray(r)&&r.forEach(i=>{a.push({url:i,review:t})})}),J(a),m.length>0&&s()},[m]);const Z=s=>{const{name:a,value:t}=s.target;q(r=>({...r,[a]:t}))},ge=()=>{x?je():F(!0)},je=async()=>{if(!w)return alert("Introduce tu contraseña para confirmar.");const{error:s}=await o.auth.signInWithPassword({email:n.email,password:w});if(s)return alert("Contraseña incorrecta.");await o.auth.updateUser({data:{name:h.name,phone:h.phone}}),await o.from("profiles").update({name:h.name,phone:h.phone}).eq("email",n.email),F(!1),y("")},we=async()=>{if(!w||!N||N!==D)return alert("Verifica las contraseñas.");H(!0),T(!1);const{error:s}=await o.auth.updateUser({password:N});H(!1),s?alert("Error al actualizar la contraseña."):(T(!0),y(""),U(""),M(""),setTimeout(()=>T(!1),3e3))},be=async()=>{await ae(),te("/")},K=(s,a)=>{const t=typeof s.image_urls=="string"?JSON.parse(s.image_urls):s.image_urls,r=E.findIndex(i=>i.review.id===s.id&&t[a]===i.url);R(r),_(s)},Q=()=>{R(null),_(null)},ve=async s=>{if(window.confirm("¿Seguro que quieres eliminar esta reseña?"))try{const a=typeof s.image_urls=="string"?JSON.parse(s.image_urls):s.image_urls;if(Array.isArray(a)&&a.length>0){const i=a.map(c=>decodeURIComponent(new URL(c).pathname.split("/storage/v1/object/public/reviews/")[1]));i.length>0&&await o.storage.from("reviews").remove(i)}await o.from("reviews").delete().eq("id",s.id);const{data:t,error:r}=await o.from("profiles").select("points, name").eq("id",n.id).single();if(!r&&t){const i=Math.max(0,t.points-5);await o.from("profiles").update({points:i}).eq("id",n.id);const{data:{session:c}}=await o.auth.getSession();await fetch("https://dspsrnprvrpjrkicxiso.functions.supabase.co/send-points-update",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c==null?void 0:c.access_token}`},body:JSON.stringify({email:n.email,name:t.name,points:i,changeType:"lose"})})}G()}catch(a){console.error("Error al eliminar reseña:",a)}},ye=n.email==="vetacreativalaser@gmail.com";return de||!n?e.jsx("p",{className:"text-center p-10",children:"Cargando perfil..."}):e.jsxs("div",{className:"max-w-6xl mx-auto py-10 px-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6 text-center sm:text-left",children:[e.jsxs("div",{className:"flex flex-col items-center sm:flex-row sm:items-center sm:gap-4 w-full sm:w-auto",children:[e.jsx("div",{className:"w-20 h-20 rounded-full bg-gray-200 flex items-center justify-center mx-auto sm:mx-0",children:e.jsx(Y,{className:"w-10 h-10 text-gray-500"})}),e.jsxs("div",{className:"mt-2 sm:mt-0",children:[e.jsx("h1",{className:"text-2xl font-bold text-black",children:n.name}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Nivel ",L," · ",g," puntos"]})]})]}),e.jsx("div",{className:"flex justify-center sm:justify-end gap-2 flex-wrap",children:ye&&e.jsx(C,{to:"/admin/dashboard",children:e.jsxs(u,{variant:"secondary",className:"text-xs w-full sm:w-auto",children:[e.jsx($e,{className:"w-4 h-4 mr-1"})," Administrador"]})})})]}),e.jsxs(Ce,{defaultValue:"principal",children:[e.jsxs(Pe,{className:"flex flex-wrap sm:grid sm:grid-cols-4 gap-2 w-full mb-6 justify-center bg-gray-100 rounded-t-xl px-4 py-3 min-h-[64px] border-b border-gray-200 shadow-none",children:[e.jsxs(P,{value:"principal",className:"flex flex-col items-center text-xs sm:text-sm rounded-t-xl focus:outline-none data-[state=active]:bg-[#ffffff] data-[state=active]:shadow-none",children:[e.jsx(Y,{className:"w-5 h-5 mb-1"}),"Principal"]}),e.jsxs(P,{value:"info",className:"flex flex-col items-center text-xs sm:text-sm rounded-t-xl focus:outline-none data-[state=active]:bg-[#ffffff] data-[state=active]:shadow-none",children:[e.jsx(ee,{className:"w-5 h-5 mb-1"}),"Info"]}),e.jsxs(P,{value:"compras",className:"flex flex-col items-center text-xs sm:text-sm rounded-t-xl focus:outline-none data-[state=active]:bg-[#ffffff] data-[state=active]:shadow-none",children:[e.jsx(se,{className:"w-5 h-5 mb-1"}),"Compras"]}),e.jsxs(P,{value:"reseñas",className:"flex flex-col items-center text-xs sm:text-sm rounded-t-xl focus:outline-none data-[state=active]:bg-[#ffffff] data-[state=active]:shadow-none",children:[e.jsx(I,{className:"w-5 h-5 mb-1"}),"Reseñas"]})]}),e.jsxs("div",{className:"  flex flex-col gap-6 sm:gap-2 px-4",children:[e.jsx(k,{value:"principal",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"rounded-2xl p-4 bg-white shadow-md border",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("h2",{className:"font-semibold text-lg",children:"Progreso"}),e.jsxs("div",{className:"flex flex-col items-center justify-center",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-green-500 text-white flex items-center justify-center text-lg font-bold shadow",children:L}),e.jsx("span",{className:"text-xs text-gray-600 mt-1",children:"nivel"})]})]}),e.jsxs("p",{className:"text-sm",children:["Puntos: ",g]}),e.jsx("div",{className:"mt-2 w-full bg-gray-200 h-3 rounded-full overflow-hidden",children:e.jsx("div",{className:"bg-green-500 h-full",style:{width:`${S}%`}})}),e.jsx("p",{className:"text-xs text-gray-600 mt-1",children:S>98?`Te falta ${100-S} punto para subir al nivel ${B}.`:`Te faltan ${100-S} puntos para alcanzar el nivel ${B}. ¡Sigue así!`})]}),e.jsxs("div",{className:"rounded-2xl p-4 bg-white shadow-md border",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h2",{className:"font-semibold text-lg",children:"Favoritos"}),e.jsx(C,{to:"/favoritos",children:e.jsx(u,{size:"sm",variant:"link",children:"Ver todos"})})]}),e.jsxs("ul",{className:"text-sm text-gray-700 space-y-1",children:[A.slice(0,4).map(s=>{const a=ie.find(t=>t.id===s.product_id);return e.jsxs("li",{children:["• ",(a==null?void 0:a.name)||"Producto eliminado"]},s.id)}),A.length===0&&e.jsx("li",{children:"No hay favoritos"})]})]}),e.jsxs("div",{className:"rounded-2xl p-4 bg-white shadow-md border",children:[e.jsx("h2",{className:"font-semibold text-lg mb-2",children:"Recompensas"}),e.jsx("p",{className:"text-sm text-gray-600 mb-1",children:"Cada 100 puntos subes un nivel."}),e.jsx("p",{className:"text-sm text-gray-600",children:"Recibirás regalos sorpresa por correo al subir de nivel 🎁"})]})]})}),e.jsx(k,{value:"info",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"p-4 bg-white border shadow-md rounded-2xl space-y-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Datos de contacto"}),e.jsx(f,{htmlFor:"name",children:"Nombre completo"}),e.jsx(p,{id:"name",name:"name",value:h.name,onChange:Z,disabled:!x}),e.jsx(f,{htmlFor:"email",children:"Correo electrónico"}),e.jsx(p,{id:"email",name:"email",value:h.email,disabled:!0,className:"bg-gray-100"}),e.jsx(f,{htmlFor:"phone",children:"Teléfono"}),e.jsx(p,{id:"phone",name:"phone",value:h.phone,onChange:Z,disabled:!x}),x&&e.jsxs(e.Fragment,{children:[e.jsx(f,{htmlFor:"currentPassword",children:"Contraseña actual"}),e.jsx(p,{id:"currentPassword",name:"currentPassword",type:"password",value:w,onChange:s=>y(s.target.value)})]}),e.jsx(u,{onClick:ge,variant:x?"default":"outline",children:x?e.jsxs(e.Fragment,{children:[e.jsx(Fe,{className:"w-4 h-4 mr-1"}),"Guardar"]}):e.jsxs(e.Fragment,{children:[e.jsx(qe,{className:"w-4 h-4 mr-1"}),"Editar"]})}),!x&&e.jsx(C,{to:"/forgot-password",children:e.jsx(u,{variant:"link",className:"text-sm text-gray-600 ml-4 hover:text-black p-0 h-auto",children:"¿Olvidaste tu contraseña?"})})]}),e.jsxs("div",{className:"p-4 bg-white border shadow-md rounded-2xl space-y-4",children:[e.jsx("h2",{className:"text-lg font-s emibold",children:"Cambiar contraseña"}),e.jsx(f,{htmlFor:"newPassword",children:"Nueva contraseña"}),e.jsx(p,{id:"newPassword",type:"password",value:N,onChange:s=>U(s.target.value)}),e.jsx(f,{htmlFor:"confirmPassword",children:"Confirmar nueva contraseña"}),e.jsx(p,{id:"confirmPassword",type:"password",value:D,onChange:s=>M(s.target.value)}),e.jsx(f,{htmlFor:"currentPassword",children:"Contraseña actual"}),e.jsx(p,{id:"currentPassword",type:"password",value:w,onChange:s=>y(s.target.value)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(u,{onClick:we,variant:"default",disabled:W,children:"Actualizar contraseña"}),W&&e.jsx("div",{className:"  w-4 h-4 border-2 border-gray-300 border-t-blue-500 rounded-full animate-spin"}),pe&&e.jsx("div",{className:"text-green-600 text-lg font-bold",children:"✓"})]})]}),e.jsxs("div",{className:"p-4 bg-white border shadow-md rounded-2xl space-y-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Contacto"}),e.jsx("p",{className:"text-sm text-gray-600",children:"¿Tienes alguna duda o problema? Escríbenos a:"}),e.jsxs("a",{href:"https://mail.google.com/mail/?view=cm&to=vetacreativalaser@gmail.com",target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 text-sm text-gray-800 hover:underline",children:[e.jsx(ee,{className:"w-4 h-4"}),"vetacreativalaser@gmail.com"]})]})]})}),e.jsx(k,{value:"compras",children:$.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:$.map(s=>e.jsxs("div",{className:"p-4 bg-white border shadow-md rounded-2xl",children:[e.jsxs("h3",{className:"font-medium text-black flex items-center",children:[e.jsx(se,{className:"mr-2 h-4 w-4"})," ",s.name||"Compra"]}),e.jsx("p",{className:"text-gray-600 text-sm mt-1",children:s.description}),e.jsxs("div",{className:"flex justify-between items-center mt-2",children:[e.jsx("span",{className:`px-2 py-0.5 text-xs font-medium rounded-full ${s.status==="En preparación"?"bg-yellow-100 text-yellow-800":s.status==="Enviado"?"bg-blue-100 text-blue-800":s.status==="Finalizada"?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"}`,children:s.status||"Sin estado"}),e.jsx("p",{className:"text-xs text-gray-500",children:new Date(s.created_at).toLocaleDateString()})]})]},s.id))}):e.jsx("p",{className:"text-sm text-gray-500",children:"Aún no has realizado ninguna compra."})}),e.jsxs(k,{value:"reseñas",children:[m.length===0?e.jsx("p",{className:"text-gray-500",children:"No has escrito reseñas todavía."}):e.jsx("div",{className:"flex flex-col space-y-8 pt-4 pb-10 min-h-screen",children:m.map(s=>{var d;const a=typeof s.image_urls=="string"?JSON.parse(s.image_urls):s.image_urls,t=((d=n.name)==null?void 0:d.split(" ").slice(0,2).join(" "))||"Usuario",r=(a==null?void 0:a.slice(0,2))||[],i=(a==null?void 0:a.length)>2?a.length-2:0,c=xe<500;return e.jsx("div",{className:"bg-white rounded-xl border shadow-sm p-4 select-none",children:e.jsxs("div",{className:`flex ${c?"flex-col":"flex-row items-start"} gap-4`,children:[e.jsxs("div",{className:"flex-1 min-w-0 space-y-2 overflow-hidden",children:[e.jsx("p",{className:"text-sm font-semibold text-black truncate",children:t}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex gap-1",children:[1,2,3,4,5].map(b=>e.jsx(I,{className:`w-4 h-4 ${b<=s.rating?"text-yellow-400":"text-gray-300"}`,fill:b<=s.rating?"currentColor":"none"},b))}),e.jsx(u,{size:"icon",variant:"ghost",onClick:()=>ve(s),children:e.jsx(Ae,{className:"w-4 h-4 text-red-500"})})]}),s.product_id&&e.jsx(C,{to:`/productos/${s.product_id}`,className:"text-sm text-blue-600 hover:underline",children:"Ver producto"}),e.jsx("p",{className:"text-sm text-gray-700 text-justify break-words whitespace-pre-wrap",children:s.content})]}),Array.isArray(a)&&a.length>0&&e.jsx("div",{className:`image-grid-2 ${c?"justify-start":"justify-center items-center self-center"}`,children:r.map((b,v)=>e.jsxs("div",{className:"image-container",children:[e.jsx("img",{src:b,onClick:()=>K(s,v),className:"review-image",alt:`img-${v}`,draggable:!1}),v===r.length-1&&i>0&&e.jsxs("div",{className:"image-overlay",onClick:()=>K(s,v),children:["+",i]})]},v))})]})},s.id)})}),O!==null&&e.jsx(ke,{open:!0,onOpenChange:Q,children:e.jsx("div",{className:"fixed inset-0 z-50 bg-black/90 flex items-center justify-center",onClick:Q,children:e.jsxs("div",{className:"bg-white rounded shadow-lg max-w-3xl w-full p-4 relative",onClick:s=>s.stopPropagation(),children:[e.jsx(_e,{initialSlide:O,modules:[Ee,Le],pagination:{clickable:!0},loop:!0,allowTouchMove:!0,className:"mb-4 select-none swiper",onSlideChange:({activeIndex:s})=>{var t;const a=(t=E[s])==null?void 0:t.review;(a==null?void 0:a.id)!==(j==null?void 0:j.id)&&_(a)},children:E.map((s,a)=>e.jsx(Te,{children:e.jsx("img",{src:s.url,alt:`slide-${a}`,className:"w-full h-auto max-h-[70vh] object-contain mx-auto select-none",draggable:!1})},a))}),e.jsx("button",{onClick:()=>{var s,a;return(a=(s=document.querySelector(".swiper"))==null?void 0:s.swiper)==null?void 0:a.slidePrev()},className:"custom-swiper-prev absolute left-2 top-1/2 transform -translate-y-1/2 bg-white bg-opacity-70 rounded-full p-1 shadow hover:bg-opacity-90 z-10",children:e.jsx(Ie,{className:"h-5 w-5 text-black"})}),e.jsx("button",{onClick:()=>{var s,a;return(a=(s=document.querySelector(".swiper"))==null?void 0:s.swiper)==null?void 0:a.slideNext()},className:"custom-swiper-next absolute right-2 top-1/2 transform -translate-y-1/2 bg-white bg-opacity-70 rounded-full p-1 shadow hover:bg-opacity-90 z-10",children:e.jsx(ze,{className:"h-5 w-5 text-black"})}),j&&e.jsxs("div",{className:"text-center text-sm",children:[e.jsx("p",{className:"font-semibold text-black mb-1",children:((X=n.name)==null?void 0:X.split(" ").slice(0,2).join(" "))||"Usuario"}),e.jsx("div",{className:"flex justify-center gap-1 mb-1",children:[1,2,3,4,5].map(s=>e.jsx(I,{className:`w-4 h-4 ${s<=j.rating?"text-yellow-400":"text-gray-300"}`,fill:s<=j.rating?"currentColor":"none"},s))})]})]})})})]})]})]}),e.jsx(u,{className:"w-full sm:w-auto mt-8 border border-red-500 text-red-500 bg-white hover:bg-red-50",onClick:be,children:"Cerrar sesión"})]})};export{He as default};
